package com.chron_stat_android;

import android.os.Bundle;
import android.app.Activity;
import android.content.Intent;
import android.content.SharedPreferences;
import android.view.KeyEvent;
import android.view.View;
import android.view.inputmethod.EditorInfo;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.TextView.OnEditorActionListener;
import android.widget.Toast;

/*******************************************************************************
 * LoginActivity.java
 * 
 * @author Crescenzio Fabio
 * @author Fresco Alain
 * @author Therisod Romain
 * @author Triki Mohamed
 * @author Walpen Laurian
 * 
 * @goal Activité gérant l'authentification d'un utilisateur avant que celui-ci
 *       puisse utiliser les fonctionnalités de l'application.
 * 
 * @notes L'authentification ne fonctionne pas encore car aucun utilisateur avec
 *        mot de passe n'est présent dans la base de donné. Le mot de passe pour
 *        procéder est 1234 (l'utilisateur n'a pas d'importance)
 ******************************************************************************/
public class LoginActivity extends Activity {
	private final static String LOGIN_API_ENDPOINT_URL = "http://chron-stats.herokuapp.com/sessions.json";
	private SharedPreferences preferences;
	private String username;
	private String password;

	/***************************************************************************
	 * Ajoute un OnClickListener sur le bouton d'envoi du clavier afin de gérer
	 * l'authentification.
	 * 
	 * Ajoute un OnClickListener sur le bouton d'envoi afin de gérer
	 * l'authentification.
	 * 
	 * @see android.app.Activity#onCreate(android.os.Bundle)
	 **************************************************************************/
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_login);
		
		preferences = getSharedPreferences("CurrentUser", MODE_PRIVATE);

		// Enregistre l'action listener pour le bouton d'envoi du clavier
		EditText editText = (EditText) findViewById(R.id.editText_password);
		editText.setOnEditorActionListener(new OnEditorActionListener() {
			@Override
			public boolean onEditorAction(TextView v, int actionId,
					KeyEvent event) {
				boolean handled = false;
				if (actionId == EditorInfo.IME_ACTION_SEND) {
					sendLogin();
					handled = true;
				}
				return handled;
			}
		});

		// Enregistre l'action listener pour le bouton Envoyer...
		((Button) findViewById(R.id.button_sendLogin))
				.setOnClickListener(new View.OnClickListener() {
					@Override
					public void onClick(View v) {
						sendLogin();
					}
				});
	}

	/***************************************************************************
	 * Gère l'envoi de l'authentification au serveur
	 * 
	 * Ici, contrôle seulement que le mot de passe est correct et passe à
	 * l'activité principale, sinon affiche un Toast informant que le mot de
	 * passe est erroné
	 **************************************************************************/
	private void sendLogin() {
	    EditText usernameView = (EditText) findViewById(R.id.editText_name);
	    username = usernameView.getText().toString();
	    EditText passwordView = (EditText) findViewById(R.id.editText_password);
	    password = passwordView.getText().toString();

	    if (username.length() == 0 || password.length() == 0) {
	        // input fields are empty
	        Toast.makeText(this, "Veuillez remplir les champs",
	            Toast.LENGTH_LONG).show();
	        return;
	    } else {
	        LoginTask loginTask = new LoginTask(LoginActivity.this);
	        loginTask.setMessageLoading("Logging in...");
	        loginTask.execute(LOGIN_API_ENDPOINT_URL);
	    }
	    
		EditText passwordView = (EditText) findViewById(R.id.editText_password);
		if (passwordView.getText().toString().compareTo(password) == 0) {
			Intent intent = new Intent(getApplicationContext(),
					TeamListFragment.class);
			startActivity(intent);
		} else {
			Toast.makeText(getApplicationContext(),
					"Authentification échouée.\nLe mot de passe est erroné",
					Toast.LENGTH_SHORT).show();
		}
	}
}
